var $,Board=function(){function n(){this.isFlipped=!1}return n.prototype.initBoard=function(){var n=this;this.serverApi=new ServerApi;this.boardDrawer=new BoardDrawer;this.serverApi.registerOnServer(function(){n.boardDrawer.setFlipClickHandler(function(){return n.flipBoard()});n.boardDrawer.setNewGameClickHandler(function(){return n.serverApi.clearGameOnServer(function(t){return n.showFiguresOnBoard(t)})});n.showBoard()})},n.prototype.showBoard=function(){var n=this;this.serverApi.getFiguresFromServer(function(t){n.figuresCache=new Array(t.length-1);var i=Math.sqrt(n.figuresCache.length);$(".board").width(i*80);$(".board").height(i*80);n.boardDrawer.drawSquares(n.isFlipped,i);n.boardDrawer.setDropFigureOnSquareHandler(function(t,i){n.moveFigureOnBoard(t,i);n.serverApi.moveFigureOnServer(t,i,function(t){return n.showFiguresOnBoard(t)})});n.showFiguresOnBoard(t)})},n.prototype.flipBoard=function(){this.isFlipped=!this.isFlipped;this.showBoard()},n.prototype.moveFigureOnBoard=function(n,t){var i=this.figuresCache[n];this.showFigureAt(n,"1");this.showFigureAt(t,i)},n.prototype.showFiguresOnBoard=function(n){var i=n.length-1,t;for(n[n.length-1]!=="w"&&n[n.length-1]!=="b"&&(i=Math.max(n.indexOf("w"),n.indexOf("b"))),t=0;t<i;t++)this.showFigureAt(t,n[t]);n[i]=="w"?$(".turn").text("Ход белых"):$(".turn").text("Ход черных")},n.prototype.showFigureAt=function(n,t){this.figuresCache[n]!==t&&(this.figuresCache[n]=t,this.boardDrawer.drawFigure(n,t))},n}(),ServerApi=function(){function n(){}return n.prototype.registerOnServer=function(n){var t=this;$.post("/api/register",function(i){t.registrationId=i;n(i)})},n.prototype.clearGameOnServer=function(n){$.post("/api/newgame?registrationId="+this.registrationId,n)},n.prototype.getFiguresFromServer=function(n){$.post("/api/getfigures?registrationId="+this.registrationId,n)},n.prototype.moveFigureOnServer=function(n,t,i){$.post("/api/movefigure?fromCoord="+n+"&toCoord="+t+"&registrationId="+this.registrationId,i)},n}(),BoardDrawer=function(){function n(){}return n.prototype.setFlipClickHandler=function(n){$(".flip").click(n)},n.prototype.setNewGameClickHandler=function(n){$(".newGame").click(n)},n.prototype.drawSquares=function(n,t){var r,i;for($(".board").html(""),r='<div  id=s$coord class="square $color"><\/div>',i=0;i<t*t;i++)$(".board").append(r.replace("$coord",""+(n?t*t-1-i:i)).replace("$color",this.isBlackSquareAt(i,t)?"black":"white"))},n.prototype.drawFigure=function(n,t){$("#s"+n).html("<div id=f$coord class=figure>$figure<\/div>".replace("$coord",""+n).replace("$figure",this.gettChessSymbol(t)));$(".figure").draggable()},n.prototype.setDropFigureOnSquareHandler=function(n){$(".square").droppable({drop:function(t,i){var r=i.draggable.attr("id").substring(1),u=this.id.substring(1);n(r,u)}})},n.prototype.isBlackSquareAt=function(n,t){return(n%t+Math.floor(n/t))%2!=0},n.prototype.gettChessSymbol=function(n){switch(n){case"K":return"&#9812;";case"Q":return"&#9813;";case"R":return"&#9814;";case"B":return"&#9815;";case"N":return"&#9816;";case"P":return"&#9817;";case"k":return"&#9818;";case"q":return"&#9819;";case"r":return"&#9820;";case"b":return"&#9821;";case"n":return"&#9822;";case"p":return"&#9823;";case"k":return"&#9824;"}return""},n}();