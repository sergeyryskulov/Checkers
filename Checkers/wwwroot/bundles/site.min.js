var $,Board=function(){function n(){}return n.prototype.initBoard=function(){var n=this,t;this.serverApi=new ServerApi;this.boardDrawer=new BoardDrawer;t="";window.location.href.split("?pos=").length===2&&(t=window.location.href.split("?pos=")[1]);this.serverApi.registerOnServer(t,function(){n.boardDrawer.setNewGameClickHandler(function(){return n.serverApi.clearGameOnServer(function(t){return n.showFiguresOnBoard(t)})});n.showBoard()})},n.prototype.showBoard=function(){var n=this;this.serverApi.getFiguresFromServer(function(t){n.figuresCache=new Array(t.length-1);var i=Math.sqrt(n.figuresCache.length);n.boardDrawer.drawSquares(i);n.boardDrawer.setDropFigureOnSquareHandler(function(t,i){n.moveFigureOnBoard(t,i);n.serverApi.moveFigureOnServer(t,i,function(t){return n.showFiguresOnBoard(t)})});n.showFiguresOnBoard(t)})},n.prototype.moveFigureOnBoard=function(n,t){var i=this.figuresCache[n];this.showFigureAt(n,"1");this.showFigureAt(t,i)},n.prototype.getFiguresLength=function(n){var t=n.length-1;return n[n.length-1]!=="w"&&n[n.length-1]!=="W"&&n[n.length-1]!=="b"&&n[n.length-1]!=="B"&&(t=Math.max(n.indexOf("w"),n.indexOf("W"),n.indexOf("b"),n.indexOf("B"))),t},n.prototype.showFiguresOnBoard=function(n){var r=this,i,t;for(console.log(n),i=this.getFiguresLength(n),t=0;t<i;t++)this.showFigureAt(t,n[t]);n[i]==="b"&&this.serverApi.intellectStep(function(n){return r.intellectStepCalculated(n)})},n.prototype.intellectStepCalculated=function(n){for(var u=this,i=-1,r=-1,t=0;t<this.getFiguresLength(n);t++)n[t]=="1"&&(this.figuresCache[t]=="p"||this.figuresCache[t]=="q")&&(i=t),(n[t]=="p"||n[t]=="q")&&this.figuresCache[t]=="1"&&(r=t);i!==-1&&r!==-1?this.boardDrawer.drawMoving(i,r,function(){return u.showFiguresOnBoard(n)}):this.showFiguresOnBoard(n)},n.prototype.showFigureAt=function(n,t){this.figuresCache[n]!==t&&(this.figuresCache[n]=t,this.boardDrawer.drawFigure(n,t))},n}(),ServerApi=function(){function n(){}return n.prototype.registerOnServer=function(n,t){var i=this;$.post("/api/register?position="+n,function(n){i.registrationId=n;t(n)})},n.prototype.clearGameOnServer=function(n){$.post("/api/newgame?registrationId="+this.registrationId,n)},n.prototype.getFiguresFromServer=function(n){$.post("/api/getfigures?registrationId="+this.registrationId,n)},n.prototype.moveFigureOnServer=function(n,t,i){$.post("/api/movefigure?fromCoord="+n+"&toCoord="+t+"&registrationId="+this.registrationId,i)},n.prototype.intellectStep=function(n){$.post("/api/intellectStep?registrationId="+this.registrationId,n)},n}(),BoardDrawer=function(){function n(){}return n.prototype.setNewGameClickHandler=function(n){$(".button__new").click(n)},n.prototype.drawSquares=function(n){var i=Math.min(document.documentElement.clientWidth,document.documentElement.clientHeight)-100,t,r,u;for($(".board__inner").width(i),$(".board__inner").height(i),$(".board__inner").html(""),t=0;t<n*n;t++)r=this.isBlackSquareAt(t,n)?"black":"white",u="<div id=s"+t+' class="square square_'+r+'" ><\/div>',$(".board__inner").append(u)},n.prototype.drawMoving=function(n,t,i){$("#f"+n).css("position","relative");$("#f"+n).css("z-index",100);var r=$("#s"+t).position().left-$("#s"+n).position().left,u=$("#s"+t).position().top-$("#s"+n).position().top;$("#f"+n).animate({left:r,top:u},500,i)},n.prototype.drawFigure=function(n,t){var i="<div id=f"+n+' class="figure figure_'+t+'"><\/div>';$("#s"+n).html(i);(t=="P"||t=="Q")&&$("#s"+n+" .figure").mousedown(function(){$(this).css("cursor","url(/pages/board/grab.cur), move")}).mouseup(function(){$(this).css("cursor","pointer")}).mouseleave(function(){$(this).css("cursor","pointer")}).draggable({start:function(){$(this).css("cursor","url(/pages/board/grab.cur), move")}})},n.prototype.setDropFigureOnSquareHandler=function(n){$(".square").droppable({drop:function(t,i){var r=i.draggable.attr("id").substring(1),u=this.id.substring(1);n(r,u)}})},n.prototype.isBlackSquareAt=function(n,t){return(n%t+Math.floor(n/t))%2!=0},n}();