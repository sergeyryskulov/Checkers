var $,Game=function(){function n(){}return n.prototype.initGame=function(){var n=this,t;this._serverRepository=new ServerRepository;this._gameDrawer=new GameDrawer;t="";window.location.href.split("?pos=").length===2&&(t=window.location.href.split("?pos=")[1]);this._serverRepository.registerOnServer(t,function(){n._gameDrawer.setNewGameClickHandler(function(){return n._serverRepository.clearGameOnServer(function(t){return n.showFiguresOnBoard(t)})});n.showBoard()})},n.prototype.showBoard=function(){var n=this;this._serverRepository.getFiguresFromServer(function(t){n._figuresCache=new Array(t.length-1);var i=Math.sqrt(n._figuresCache.length);n._gameDrawer.drawSquares(i);n._gameDrawer.setDropFigureOnSquareHandler(function(t,i){n.moveFigureOnBoard(t,i);n._serverRepository.moveFigureOnServer(n._oldBoardState,t,i,function(t){return n.showFiguresOnBoard(t)})});n.showFiguresOnBoard(t)})},n.prototype.moveFigureOnBoard=function(n,t){var i=this._figuresCache[n];this.showFigureAt(n,"1");this.showFigureAt(t,i)},n.prototype.getFiguresLength=function(n){var t=n.length-1;return n[n.length-1]!=="w"&&n[n.length-1]!=="W"&&n[n.length-1]!=="b"&&n[n.length-1]!=="B"&&(t=Math.max(n.indexOf("w"),n.indexOf("W"),n.indexOf("b"),n.indexOf("B"))),t},n.prototype.showFiguresOnBoard=function(n){var r=this,i,t;for(this._oldBoardState=n,console.log(n),i=this.getFiguresLength(n),t=0;t<i;t++)this.showFigureAt(t,n[t]);n[i]==="b"&&this._serverRepository.intellectStep(this._oldBoardState,function(n){return r.intellectStepCalculated(n)})},n.prototype.intellectStepCalculated=function(n){for(var u=this,i=-1,r=-1,t=0;t<this.getFiguresLength(n);t++)n[t]=="1"&&(this._figuresCache[t]=="p"||this._figuresCache[t]=="q")&&(i=t),(n[t]=="p"||n[t]=="q")&&this._figuresCache[t]=="1"&&(r=t);i!==-1&&r!==-1?this._gameDrawer.drawMoving(i,r,function(){return u.showFiguresOnBoard(n)}):this.showFiguresOnBoard(n)},n.prototype.showFigureAt=function(n,t){this._figuresCache[n]!==t&&(this._figuresCache[n]=t,this._gameDrawer.drawFigure(n,t))},n}(),BoardDrawer=function(){function n(){}return n.prototype.drawBoard=function(n){var t=Math.min(document.documentElement.clientWidth,document.documentElement.clientHeight)-100;$(".board__inner").width(t);$(".board__inner").height(t);$(".board__inner").html(n)},n}(),SquareDrawer=function(){function n(){}return n.prototype.getSquaresHtml=function(n){for(var r,u,i="",t=0;t<n*n;t++)r=this.isBlackSquareAt(t,n)?"black":"white",u="<div id=s"+t+' class="square square_'+r+'" ><\/div>',i+=u;return i},n.prototype.setDropFigureOnSquareHandler=function(n){$(".square").droppable({drop:function(t,i){var r=i.draggable.attr("id").substring(1),u=this.id.substring(1);n(r,u)}})},n.prototype.isBlackSquareAt=function(n,t){return(n%t+Math.floor(n/t))%2!=0},n}(),FigureDrawer=function(){function n(){}return n.prototype.drawMoving=function(n,t,i){$("#f"+n).css("position","relative");$("#f"+n).css("z-index",100);var r=$("#s"+t).position().left-$("#s"+n).position().left,u=$("#s"+t).position().top-$("#s"+n).position().top;$("#f"+n).animate({left:r,top:u},500,i)},n.prototype.getHtml=function(n,t){return"<div id=f"+n+' class="figure figure_'+t+'"><\/div>'},n.prototype.setHandlers=function(n,t){(t=="P"||t=="Q")&&$("#f"+n).mousedown(function(){$(this).css("cursor","url(/images/movingCursor.cur), move")}).mouseup(function(){$(this).css("cursor","pointer")}).mouseleave(function(){$(this).css("cursor","pointer")}).draggable({start:function(){$(this).css("cursor","url(/images/movingCursor.cur), move")}})},n}(),RulesDrawer=function(){function n(){}return n.prototype.drawRules=function(){$(".rules__dialog").show();$(".rules__cover").show();$(".rules__close").click(function(){$(".rules__cover").hide();$(".rules__dialog").hide()})},n}(),GameDrawer=function(){function n(){this._squareDrawer=new SquareDrawer;this._figureDrawer=new FigureDrawer;this._boardDrawer=new BoardDrawer;this._rulesDrawer=new RulesDrawer}return n.prototype.setNewGameClickHandler=function(n){var t=this;$(".button__new").click(n);$(".button__rules").click(function(){return t._rulesDrawer.drawRules()})},n.prototype.drawSquares=function(n){var t=this._squareDrawer.getSquaresHtml(n);this._boardDrawer.drawBoard(t)},n.prototype.drawMoving=function(n,t,i){this._figureDrawer.drawMoving(n,t,i)},n.prototype.drawFigure=function(n,t){var i=this._figureDrawer.getHtml(n,t);$("#s"+n).html(i);this._figureDrawer.setHandlers(n,t)},n.prototype.setDropFigureOnSquareHandler=function(n){this._squareDrawer.setDropFigureOnSquareHandler(n)},n}(),ServerRepository=function(){function n(){}return n.prototype.registerOnServer=function(n,t){var i=this;$.post("/api/register?position="+n,function(n){i._registrationId=n;t(n)})},n.prototype.clearGameOnServer=function(n){$.post("/api/newgame?registrationId="+this._registrationId,n)},n.prototype.getFiguresFromServer=function(n){$.post("/api/getfigures?registrationId="+this._registrationId,n)},n.prototype.moveFigureOnServer=function(n,t,i,r){$.post("/api/movefigure?fromCoord="+t+"&toCoord="+i+"&registrationId="+this._registrationId+"&boardState="+n,r)},n.prototype.intellectStep=function(n,t){$.post("/api/intellectStep?boardState="+n,t)},n}();